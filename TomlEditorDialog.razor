@namespace Mas.Infrastructure.BlazorComponents

@using MudBlazor
@using Tomlyn
@using Tomlyn.Model

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Edit TOML Configuration</MudText>

        @if (_errorMessage != null)
        {
            <MudAlert Severity="Severity.Error" Class="mb-3">@_errorMessage</MudAlert>
        }

        <MudPaper Class="pa-4" Elevation="0">
            @foreach (var entry in _entries)
            {
                <MudPaper Class="pa-3 mb-3" Elevation="1">
                    @if (entry.IsCategory)
                    {
                        <MudText Typo="Typo.h6" Class="mb-2">[@entry.Key]</MudText>
                        @foreach (var subEntry in entry.SubEntries)
                        {
                            <div class="d-flex align-center mb-2">
                                @RenderEntryEditor(subEntry)
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                             Size="Size.Small"
                                             OnClick="@(() => RemoveSubEntry(entry, subEntry))" />
                            </div>
                        }
                        <MudButton StartIcon="@Icons.Material.Filled.Add"
                                 Size="Size.Small"
                                 OnClick="@(() => AddSubEntry(entry))">
                            Add Entry
                        </MudButton>
                    }
                    else
                    {
                        <div class="d-flex align-center">
                            @RenderEntryEditor(entry)
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                         Size="Size.Small"
                                         OnClick="@(() => RemoveEntry(entry))" />
                        </div>
                    }
                </MudPaper>
            }

            <MudButton StartIcon="@Icons.Material.Filled.Add"
                     Variant="Variant.Filled"
                     Color="Color.Primary"
                     OnClick="@AddNewEntry">
                Add New Entry
            </MudButton>

            <MudButton StartIcon="@Icons.Material.Filled.Add"
                     Variant="Variant.Outlined"
                     Color="Color.Secondary"
                     Class="ml-2"
                     OnClick="@AddNewCategory">
                Add Category
            </MudButton>
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="@Save">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public string? TomlString { get; set; }

    private List<TomlEntry> _entries = new();
    private string? _errorMessage;
    private int _newEntryCounter = 0;

    protected override void OnInitialized()
    {
        if (!string.IsNullOrWhiteSpace(TomlString))
        {
            try
            {
                var model = Toml.ToModel(TomlString);
                ParseTomlModel(model);
            }
            catch (Exception ex)
            {
                _errorMessage = $"Failed to parse TOML: {ex.Message}";
            }
        }
    }

    private void ParseTomlModel(TomlTable table)
    {
        foreach (var kvp in table)
        {
            if (kvp.Value is TomlTable subTable)
            {
                // This is a category
                var categoryEntry = new TomlEntry
                {
                    Key = kvp.Key,
                    IsCategory = true,
                    SubEntries = new List<TomlEntry>()
                };

                foreach (var subKvp in subTable)
                {
                    categoryEntry.SubEntries.Add(CreateEntryFromValue(subKvp.Key, subKvp.Value));
                }

                _entries.Add(categoryEntry);
            }
            else
            {
                _entries.Add(CreateEntryFromValue(kvp.Key, kvp.Value));
            }
        }
    }

    private TomlEntry CreateEntryFromValue(string key, object value)
    {
        return value switch
        {
            string s => new TomlEntry { Key = key, ValueType = TomlValueType.String, StringValue = s },
            long l => new TomlEntry { Key = key, ValueType = TomlValueType.Integer, IntegerValue = l },
            double d => new TomlEntry { Key = key, ValueType = TomlValueType.Double, DoubleValue = d },
            TomlArray arr => CreateArrayEntry(key, arr),
            _ => new TomlEntry { Key = key, ValueType = TomlValueType.String, StringValue = value?.ToString() ?? "" }
        };
    }

    private TomlEntry CreateArrayEntry(string key, TomlArray array)
    {
        if (array.Count == 0)
        {
            return new TomlEntry { Key = key, ValueType = TomlValueType.StringArray, StringArrayValue = "" };
        }

        var firstElement = array[0];
        return firstElement switch
        {
            string _ => new TomlEntry
            {
                Key = key,
                ValueType = TomlValueType.StringArray,
                StringArrayValue = string.Join(", ", array.Cast<string>())
            },
            long _ => new TomlEntry
            {
                Key = key,
                ValueType = TomlValueType.IntegerArray,
                IntegerArrayValue = string.Join(", ", array.Cast<long>())
            },
            double _ => new TomlEntry
            {
                Key = key,
                ValueType = TomlValueType.DoubleArray,
                DoubleArrayValue = string.Join(", ", array.Cast<double>())
            },
            _ => new TomlEntry { Key = key, ValueType = TomlValueType.StringArray, StringArrayValue = "" }
        };
    }

    private RenderFragment RenderEntryEditor(TomlEntry entry) => builder =>
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "flex-grow-1 d-flex align-center gap-2");

        // Key editor
        builder.OpenComponent<MudTextField<string>>(2);
        builder.AddAttribute(3, "Label", "Key");
        builder.AddAttribute(4, "Value", entry.Key);
        builder.AddAttribute(5, "ValueChanged", EventCallback.Factory.Create<string>(this, value => entry.Key = value));
        builder.AddAttribute(6, "Class", "mr-2");
        builder.AddAttribute(7, "Style", "max-width: 200px;");
        builder.CloseComponent();

        // Type selector
        if (!entry.IsCategory)
        {
            builder.OpenComponent<MudSelect<TomlValueType>>(8);
            builder.AddAttribute(9, "Label", "Type");
            builder.AddAttribute(10, "Value", entry.ValueType);
            builder.AddAttribute(11, "ValueChanged", EventCallback.Factory.Create<TomlValueType>(this, value => {
                entry.ValueType = value;
                StateHasChanged();
            }));
            builder.AddAttribute(12, "Class", "mr-2");
            builder.AddAttribute(13, "Style", "max-width: 150px;");
            builder.AddAttribute(14, "ChildContent", (RenderFragment)(typeBuilder =>
            {
                foreach (var type in Enum.GetValues<TomlValueType>())
                {
                    typeBuilder.OpenComponent<MudSelectItem<TomlValueType>>(0);
                    typeBuilder.AddAttribute(1, "Value", type);
                    typeBuilder.AddAttribute(2, "ChildContent", (RenderFragment)(textBuilder =>
                    {
                        textBuilder.AddContent(0, type.ToString());
                    }));
                    typeBuilder.CloseComponent();
                }
            }));
            builder.CloseComponent();

            // Value editor based on type
            switch (entry.ValueType)
            {
                case TomlValueType.String:
                    builder.OpenComponent<MudTextField<string>>(15);
                    builder.AddAttribute(16, "Label", "Value");
                    builder.AddAttribute(17, "Value", entry.StringValue);
                    builder.AddAttribute(18, "ValueChanged", EventCallback.Factory.Create<string>(this, value => entry.StringValue = value));
                    builder.AddAttribute(19, "Class", "flex-grow-1");
                    builder.CloseComponent();
                    break;

                case TomlValueType.Integer:
                    builder.OpenComponent<MudNumericField<long>>(15);
                    builder.AddAttribute(16, "Label", "Value");
                    builder.AddAttribute(17, "Value", entry.IntegerValue);
                    builder.AddAttribute(18, "ValueChanged", EventCallback.Factory.Create<long>(this, value => entry.IntegerValue = value));
                    builder.AddAttribute(19, "Class", "flex-grow-1");
                    builder.CloseComponent();
                    break;

                case TomlValueType.Double:
                    builder.OpenComponent<MudNumericField<double>>(15);
                    builder.AddAttribute(16, "Label", "Value");
                    builder.AddAttribute(17, "Value", entry.DoubleValue);
                    builder.AddAttribute(18, "ValueChanged", EventCallback.Factory.Create<double>(this, value => entry.DoubleValue = value));
                    builder.AddAttribute(19, "Class", "flex-grow-1");
                    builder.CloseComponent();
                    break;

                case TomlValueType.StringArray:
                    builder.OpenComponent<MudTextField<string>>(15);
                    builder.AddAttribute(16, "Label", "Values (comma-separated)");
                    builder.AddAttribute(17, "Value", entry.StringArrayValue);
                    builder.AddAttribute(18, "ValueChanged", EventCallback.Factory.Create<string>(this, value => entry.StringArrayValue = value));
                    builder.AddAttribute(19, "Class", "flex-grow-1");
                    builder.CloseComponent();
                    break;

                case TomlValueType.IntegerArray:
                    builder.OpenComponent<MudTextField<string>>(15);
                    builder.AddAttribute(16, "Label", "Values (comma-separated)");
                    builder.AddAttribute(17, "Value", entry.IntegerArrayValue);
                    builder.AddAttribute(18, "ValueChanged", EventCallback.Factory.Create<string>(this, value => entry.IntegerArrayValue = value));
                    builder.AddAttribute(19, "Class", "flex-grow-1");
                    builder.CloseComponent();
                    break;

                case TomlValueType.DoubleArray:
                    builder.OpenComponent<MudTextField<string>>(15);
                    builder.AddAttribute(16, "Label", "Values (comma-separated)");
                    builder.AddAttribute(17, "Value", entry.DoubleArrayValue);
                    builder.AddAttribute(18, "ValueChanged", EventCallback.Factory.Create<string>(this, value => entry.DoubleArrayValue = value));
                    builder.AddAttribute(19, "Class", "flex-grow-1");
                    builder.CloseComponent();
                    break;
            }
        }

        builder.CloseElement(); // close flex container
    };

    private void AddNewEntry()
    {
        _entries.Add(new TomlEntry
        {
            Key = $"new_key_{++_newEntryCounter}",
            ValueType = TomlValueType.String,
            StringValue = ""
        });
    }

    private void AddNewCategory()
    {
        _entries.Add(new TomlEntry
        {
            Key = $"new_category_{++_newEntryCounter}",
            IsCategory = true,
            SubEntries = new List<TomlEntry>()
        });
    }

    private void AddSubEntry(TomlEntry category)
    {
        category.SubEntries.Add(new TomlEntry
        {
            Key = $"key_{category.SubEntries.Count + 1}",
            ValueType = TomlValueType.String,
            StringValue = ""
        });
    }

    private void RemoveEntry(TomlEntry entry)
    {
        _entries.Remove(entry);
    }

    private void RemoveSubEntry(TomlEntry category, TomlEntry subEntry)
    {
        category.SubEntries.Remove(subEntry);
    }

    private void Save()
    {
        try
        {
            var table = new TomlTable();

            foreach (var entry in _entries)
            {
                if (entry.IsCategory)
                {
                    var subTable = new TomlTable();
                    foreach (var subEntry in entry.SubEntries)
                    {
                        AddEntryToTable(subTable, subEntry);
                    }
                    table[entry.Key] = subTable;
                }
                else
                {
                    AddEntryToTable(table, entry);
                }
            }

            var tomlString = Toml.FromModel(table);
            MudDialog?.Close(DialogResult.Ok(tomlString));
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to generate TOML: {ex.Message}";
        }
    }

    private void AddEntryToTable(TomlTable table, TomlEntry entry)
    {
        switch (entry.ValueType)
        {
            case TomlValueType.String:
                table[entry.Key] = entry.StringValue ?? "";
                break;

            case TomlValueType.Integer:
                table[entry.Key] = entry.IntegerValue;
                break;

            case TomlValueType.Double:
                table[entry.Key] = entry.DoubleValue;
                break;

            case TomlValueType.StringArray:
                var stringArray = new TomlArray();
                if (!string.IsNullOrWhiteSpace(entry.StringArrayValue))
                {
                    foreach (var item in entry.StringArrayValue.Split(',').Select(s => s.Trim()))
                    {
                        stringArray.Add(item);
                    }
                }
                table[entry.Key] = stringArray;
                break;

            case TomlValueType.IntegerArray:
                var intArray = new TomlArray();
                if (!string.IsNullOrWhiteSpace(entry.IntegerArrayValue))
                {
                    foreach (var item in entry.IntegerArrayValue.Split(',').Select(s => s.Trim()))
                    {
                        if (long.TryParse(item, out var value))
                        {
                            intArray.Add(value);
                        }
                    }
                }
                table[entry.Key] = intArray;
                break;

            case TomlValueType.DoubleArray:
                var doubleArray = new TomlArray();
                if (!string.IsNullOrWhiteSpace(entry.DoubleArrayValue))
                {
                    foreach (var item in entry.DoubleArrayValue.Split(',').Select(s => s.Trim()))
                    {
                        if (double.TryParse(item, out var value))
                        {
                            doubleArray.Add(value);
                        }
                    }
                }
                table[entry.Key] = doubleArray;
                break;
        }
    }

    private void Cancel() => MudDialog?.Cancel();

    private class TomlEntry
    {
        public string Key { get; set; } = "";
        public bool IsCategory { get; set; }
        public List<TomlEntry> SubEntries { get; set; } = new();
        public TomlValueType ValueType { get; set; }
        public string? StringValue { get; set; }
        public long IntegerValue { get; set; }
        public double DoubleValue { get; set; }
        public string? StringArrayValue { get; set; }
        public string? IntegerArrayValue { get; set; }
        public string? DoubleArrayValue { get; set; }
    }

    private enum TomlValueType
    {
        String,
        Integer,
        Double,
        StringArray,
        IntegerArray,
        DoubleArray
    }
}
