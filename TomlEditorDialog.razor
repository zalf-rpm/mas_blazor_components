@namespace Mas.Infrastructure.BlazorComponents

@using MudBlazor
@using Tomlyn
@using Tomlyn.Model

<MudDialog>
    <DialogContent>
        @if (_errorMessage != null)
        {
            <MudAlert Severity="Severity.Error" Class="mb-3">@_errorMessage</MudAlert>
        }

        <MudPaper Class="pa-4" Elevation="0">
            @foreach (var entry in _entries)
            {
                @if (entry.IsCategory)
                {
                    <MudPaper Class="pa-3 mb-3" Elevation="1">
                        <MudText Typo="Typo.h6" Class="mb-2">[@entry.Key]</MudText>
                        @foreach (var subEntry in entry.SubEntries)
                        {
                            <div class="mb-2">
                                @RenderEntryEditor(subEntry)
                            </div>
                        }
                    </MudPaper>
                }
                else
                {
                    <div class="mb-2">
                        @RenderEntryEditor(entry)
                    </div>
                }
            }
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="@Save">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance? MudDialog { get; set; }

    [Parameter] public string? TomlString { get; set; }

    private List<TomlEntry> _entries = new();
    private string? _errorMessage;

    protected override void OnInitialized()
    {
        if (!string.IsNullOrWhiteSpace(TomlString))
        {
            try
            {
                var model = Toml.ToModel(TomlString);
                ParseTomlModel(model);
            }
            catch (Exception ex)
            {
                _errorMessage = $"Failed to parse TOML: {ex.Message}";
            }
        }
    }

    private void ParseTomlModel(TomlTable table)
    {
        foreach (var kvp in table)
        {
            if (kvp.Value is TomlTable subTable)
            {
                // This is a category
                var categoryEntry = new TomlEntry
                {
                    Key = kvp.Key,
                    IsCategory = true,
                    SubEntries = new List<TomlEntry>()
                };

                foreach (var subKvp in subTable)
                {
                    categoryEntry.SubEntries.Add(CreateEntryFromValue(subKvp.Key, subKvp.Value));
                }

                _entries.Add(categoryEntry);
            }
            else
            {
                _entries.Add(CreateEntryFromValue(kvp.Key, kvp.Value));
            }
        }
    }

    private TomlEntry CreateEntryFromValue(string key, object value)
    {
        return value switch
        {
            string s => new TomlEntry { Key = key, ValueType = TomlValueType.String, StringValue = s },
            long l => new TomlEntry { Key = key, ValueType = TomlValueType.Integer, IntegerValue = l },
            double d => new TomlEntry { Key = key, ValueType = TomlValueType.Double, DoubleValue = d },
            TomlArray arr => CreateArrayEntry(key, arr),
            _ => new TomlEntry { Key = key, ValueType = TomlValueType.String, StringValue = value?.ToString() ?? "" }
        };
    }

    private TomlEntry CreateArrayEntry(string key, TomlArray array)
    {
        if (array.Count == 0)
        {
            return new TomlEntry { Key = key, ValueType = TomlValueType.StringArray, StringArrayValue = "" };
        }

        var firstElement = array[0];
        return firstElement switch
        {
            string _ => new TomlEntry
            {
                Key = key,
                ValueType = TomlValueType.StringArray,
                StringArrayValue = string.Join(", ", array.Cast<string>())
            },
            long _ => new TomlEntry
            {
                Key = key,
                ValueType = TomlValueType.IntegerArray,
                IntegerArrayValue = string.Join(", ", array.Cast<long>())
            },
            double _ => new TomlEntry
            {
                Key = key,
                ValueType = TomlValueType.DoubleArray,
                DoubleArrayValue = string.Join(", ", array.Cast<double>())
            },
            _ => new TomlEntry { Key = key, ValueType = TomlValueType.StringArray, StringArrayValue = "" }
        };
    }

    private RenderFragment RenderEntryEditor(TomlEntry entry)
    {
        return entry.ValueType switch
        {
            TomlValueType.String => @<div class="d-flex align-center gap-2">
                                        <MudTextField @bind-Value="entry.Key" Label="Key" ReadOnly="true" Class="mr-2"
                                                      Style="max-width: 200px;"/>
                                        <MudTextField @bind-Value="entry.StringValue" Label="Value"
                                                      Class="flex-grow-1"/>
                                    </div>,

            TomlValueType.Integer => @<div class="d-flex align-center gap-2">
                                         <MudTextField @bind-Value="entry.Key" Label="Key" ReadOnly="true" Class="mr-2"
                                                       Style="max-width: 200px;"/>
                                         <MudNumericField @bind-Value="entry.IntegerValue" Label="Value"
                                                          Class="flex-grow-1"/>
                                     </div>,

            TomlValueType.Double => @<div class="d-flex align-center gap-2">
                                        <MudTextField @bind-Value="entry.Key" Label="Key" ReadOnly="true" Class="mr-2"
                                                      Style="max-width: 200px;"/>
                                        <MudNumericField @bind-Value="entry.DoubleValue" Label="Value"
                                                         Class="flex-grow-1"/>
                                    </div>,

            TomlValueType.StringArray => @<div class="d-flex align-center gap-2">
                                             <MudTextField @bind-Value="entry.Key" Label="Key" ReadOnly="true"
                                                           Class="mr-2" Style="max-width: 200px;"/>
                                             <MudTextField @bind-Value="entry.StringArrayValue"
                                                           Label="Values (comma-separated)" Class="flex-grow-1"/>
                                         </div>,

            TomlValueType.IntegerArray => @<div class="d-flex align-center gap-2">
                                              <MudTextField @bind-Value="entry.Key" Label="Key" ReadOnly="true"
                                                            Class="mr-2" Style="max-width: 200px;"/>
                                              <MudTextField @bind-Value="entry.IntegerArrayValue"
                                                            Label="Values (comma-separated)" Class="flex-grow-1"/>
                                          </div>,

            TomlValueType.DoubleArray => @<div class="d-flex align-center gap-2">
                                             <MudTextField @bind-Value="entry.Key" Label="Key" ReadOnly="true"
                                                           Class="mr-2" Style="max-width: 200px;"/>
                                             <MudTextField @bind-Value="entry.DoubleArrayValue"
                                                           Label="Values (comma-separated)" Class="flex-grow-1"/>
                                         </div>,

            _ => @<div></div>
        };
    }

    private void Save()
    {
        try
        {
            var table = new TomlTable();

            foreach (var entry in _entries)
            {
                if (entry.IsCategory)
                {
                    var subTable = new TomlTable();
                    foreach (var subEntry in entry.SubEntries)
                    {
                        AddEntryToTable(subTable, subEntry);
                    }

                    table[entry.Key] = subTable;
                }
                else
                {
                    AddEntryToTable(table, entry);
                }
            }

            var tomlString = Toml.FromModel(table);
            MudDialog?.Close(DialogResult.Ok(tomlString));
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to generate TOML: {ex.Message}";
        }
    }

    private void AddEntryToTable(TomlTable table, TomlEntry entry)
    {
        switch (entry.ValueType)
        {
            case TomlValueType.String:
                table[entry.Key] = entry.StringValue ?? "";
                break;

            case TomlValueType.Integer:
                table[entry.Key] = entry.IntegerValue;
                break;

            case TomlValueType.Double:
                table[entry.Key] = entry.DoubleValue;
                break;

            case TomlValueType.StringArray:
                var stringArray = new TomlArray();
                if (!string.IsNullOrWhiteSpace(entry.StringArrayValue))
                {
                    foreach (var item in entry.StringArrayValue.Split(',').Select(s => s.Trim()))
                    {
                        stringArray.Add(item);
                    }
                }

                table[entry.Key] = stringArray;
                break;

            case TomlValueType.IntegerArray:
                var intArray = new TomlArray();
                if (!string.IsNullOrWhiteSpace(entry.IntegerArrayValue))
                {
                    foreach (var item in entry.IntegerArrayValue.Split(',').Select(s => s.Trim()))
                    {
                        if (long.TryParse(item, out var value))
                        {
                            intArray.Add(value);
                        }
                    }
                }

                table[entry.Key] = intArray;
                break;

            case TomlValueType.DoubleArray:
                var doubleArray = new TomlArray();
                if (!string.IsNullOrWhiteSpace(entry.DoubleArrayValue))
                {
                    foreach (var item in entry.DoubleArrayValue.Split(',').Select(s => s.Trim()))
                    {
                        if (double.TryParse(item, out var value))
                        {
                            doubleArray.Add(value);
                        }
                    }
                }

                table[entry.Key] = doubleArray;
                break;
        }
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private class TomlEntry
    {
        public string Key { get; set; } = "";
        public bool IsCategory { get; set; }
        public List<TomlEntry> SubEntries { get; set; } = new();
        public TomlValueType ValueType { get; set; }
        public string? StringValue { get; set; }
        public long IntegerValue { get; set; }
        public double DoubleValue { get; set; }
        public string? StringArrayValue { get; set; }
        public string? IntegerArrayValue { get; set; }
        public string? DoubleArrayValue { get; set; }
    }

    private enum TomlValueType
    {
        String,
        Integer,
        Double,
        StringArray,
        IntegerArray,
        DoubleArray
    }

}
